#!/bin/bash
# Apply Supabase database migrations

# Color codes
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

SCHEMA_DIR="supabase/migrations"
SUPABASE_DASHBOARD="https://supabase.com/dashboard/project/djmadubptsajvdvzpdvd"

echo -e "${BLUE}Supabase Database Migration${NC}"

# Check if migrations directory exists
if [ ! -d "$SCHEMA_DIR" ]; then
  echo -e "${RED}✗ Migrations directory not found: $SCHEMA_DIR${NC}"
  exit 1
fi

# List available migration files
echo -e "${YELLOW}Available migration files:${NC}"
MIGRATION_FILES=()
while IFS= read -r -d '' file; do
  MIGRATION_FILES+=("$file")
  echo -e "${GREEN}•${NC} $(basename "$file")"
done < <(find "$SCHEMA_DIR" -name "*.sql" -print0 | sort -z)

if [ ${#MIGRATION_FILES[@]} -eq 0 ]; then
  echo -e "${RED}✗ No SQL migration files found in $SCHEMA_DIR${NC}"
  exit 1
fi

echo ""
echo -e "${YELLOW}Select migration to apply:${NC}"
select migration in "${MIGRATION_FILES[@]}" "Cancel"; do
  case $migration in
    "Cancel")
      echo -e "${YELLOW}Migration cancelled${NC}"
      exit 0
      ;;
    "")
      echo -e "${RED}Invalid selection${NC}"
      ;;
    *)
      echo ""
      echo -e "${BLUE}Migration file: $(basename "$migration")${NC}"
      echo -e "${YELLOW}Preview:${NC}"
      echo "----------------------------------------"
      head -n 20 "$migration"
      echo "----------------------------------------"
      echo ""
      echo -e "${YELLOW}To apply this migration:${NC}"
      echo -e "1. Open Supabase SQL Editor: ${BLUE}$SUPABASE_DASHBOARD/editor${NC}"
      echo -e "2. Copy the SQL from: ${GREEN}$migration${NC}"
      echo -e "3. Paste and run the query"
      echo ""
      echo -e "${YELLOW}Copy SQL to clipboard? (y/n)${NC}"
      read -r COPY_CONFIRM
      if [ "$COPY_CONFIRM" = "y" ]; then
        if command -v clip.exe &> /dev/null; then
          # Windows WSL
          cat "$migration" | clip.exe
          echo -e "${GREEN}✓ Copied to clipboard (Windows)${NC}"
        elif command -v pbcopy &> /dev/null; then
          # macOS
          cat "$migration" | pbcopy
          echo -e "${GREEN}✓ Copied to clipboard (macOS)${NC}"
        elif command -v xclip &> /dev/null; then
          # Linux
          cat "$migration" | xclip -selection clipboard
          echo -e "${GREEN}✓ Copied to clipboard (Linux)${NC}"
        else
          echo -e "${YELLOW}⚠ Clipboard tool not found. Displaying full SQL:${NC}"
          echo ""
          cat "$migration"
        fi
        echo ""
        echo -e "${BLUE}Opening Supabase Dashboard...${NC}"
        if command -v explorer.exe &> /dev/null; then
          # Windows/WSL
          explorer.exe "$SUPABASE_DASHBOARD/editor"
        elif command -v open &> /dev/null; then
          # macOS
          open "$SUPABASE_DASHBOARD/editor"
        elif command -v xdg-open &> /dev/null; then
          # Linux
          xdg-open "$SUPABASE_DASHBOARD/editor"
        else
          echo -e "${YELLOW}Navigate to: $SUPABASE_DASHBOARD/editor${NC}"
        fi
      fi
      break
      ;;
  esac
done
